---
- hosts: ctrl
  become: true
  vars:
    kubeconfig_path: /home/vagrant/.kube/config

  pre_tasks:
    - name: Ensure apt cache is up to date
      ansible.builtin.apt:
        update_cache: yes

    - name: Ensure python3-pip is installed
      ansible.builtin.apt:
        name: python3-pip
        state: present

    - name: Install Python Kubernetes client libraries
      ansible.builtin.apt:
        name:
          - python3-kubernetes
          - python3-openshift
        state: present

  tasks:
    - name: Apply MetalLB manifest
      community.kubernetes.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition: "{{ lookup('file', 'files/metallb-native.yaml') }}"

    - name: Wait for MetalLB pods to be ready
      ansible.builtin.shell: >
        kubectl wait --for=condition=ready pod
        -l app=metallb,component=controller -n metallb-system --timeout=120s
        --kubeconfig {{ kubeconfig_path }}

    - name: Apply MetalLB IPAddressPool and L2Advertisement
      community.kubernetes.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition: |
          ---
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: first-pool
            namespace: metallb-system
          spec:
            addresses:
            - 192.168.56.90-192.168.56.99
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: example
            namespace: metallb-system
          spec:
            ipAddressPools:
            - first-pool

    - name: Ensure Helm is installed on the control plane
      ansible.builtin.shell: |
        set -e
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
      args:
        creates: /usr/local/bin/helm

    - name: Add ingress-nginx Helm repository
      community.kubernetes.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
        state: present
      become: false

    - name: Install ingress-nginx chart
      community.kubernetes.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: yes
        state: present
        values:
          controller:
            service:
              loadBalancerIP: 192.168.56.90
      become: false


- import_playbook: istio.yaml