---
- hosts: ctrl
  become: true
  vars:
    kubeconfig_path: /home/vagrant/.kube/config

  pre_tasks:
    - name: Ensure apt cache is up to date
      ansible.builtin.apt:
        update_cache: yes

    - name: Ensure required packages are installed
      ansible.builtin.apt:
        name:
          - curl
          - apt-transport-https
        state: present

  tasks:
    # - name: Install MetalLB CRDs and components
    #   ansible.builtin.shell: |
    #     kubectl apply -f files/metallb-native.yaml \
    #       --kubeconfig {{ kubeconfig_path }}
    #   args:
    #     chdir: "{{ playbook_dir }}"
    - name: Download MetalLB manifest
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/metallb/metallb/main/config/manifests/metallb-native.yaml
        dest: /tmp/metallb-native.yaml
        mode: '0644'

    - name: Install MetalLB CRDs and components
      ansible.builtin.shell: |
        kubectl apply -f /tmp/metallb-native.yaml --kubeconfig {{ kubeconfig_path }}

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.shell: |
        kubectl wait -n metallb-system \
          -l app=metallb,component=controller \
          --for=condition=ready pod \
          --timeout=120s \
          --kubeconfig {{ kubeconfig_path }}

    - name: Configure MetalLB IPAddressPool and L2Advertisement
      ansible.builtin.shell: |
        kubectl apply -f - --kubeconfig {{ kubeconfig_path }} <<EOF
        apiVersion: metallb.io/v1beta1
        kind: IPAddressPool
        metadata:
          name: first-pool
          namespace: metallb-system
        spec:
          addresses:
            - 192.168.56.90-192.168.56.99
        ---
        apiVersion: metallb.io/v1beta1
        kind: L2Advertisement
        metadata:
          name: example
          namespace: metallb-system
        spec:
          ipAddressPools:
            - first-pool
        EOF

    - name: Install Helm if not present
      ansible.builtin.shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Add ingress-nginx Helm repository
      ansible.builtin.shell: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
      become: false

    - name: Install ingress-nginx
      ansible.builtin.shell: |
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx \
          --create-namespace \
          --set controller.service.loadBalancerIP=192.168.56.90 \
          --kubeconfig {{ kubeconfig_path }}
      become: false

- import_playbook: istio.yaml